stages:
  - build
  - test
  - deploy

.any-job:
  rules:
    - if: $CI_SERVER_HOST == "gitlab.mnl.de"

.gradle-job:
  extends: .any-job
  image: registry.mnl.de/org/jgrapes/jdk21-builder:v1
  variables:
    GIT_STRATEGY: clone
  cache:
    - key: dependencies
      policy: pull-push  
      paths:
        - .gradle
        - .m2
        - node_modules
    - key: "$CI_COMMIT_REF_NAME"
      policy: pull-push
      paths:
        - "*/build"
  before_script:
    - echo -n $CI_REGISTRY_PASSWORD | podman login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
    - git fetch --tags
  
build-gradle:
  stage: build
  extends: .gradle-job  
  script:
    - ./gradlew -Pdocker.registry=$CI_REGISTRY_IMAGE pushImage

.pages-job:
  extends: .any-job
  image: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/ruby:3.2
  variables:
    JEKYLL_ENV: production
    LC_ALL: C.UTF-8
  before_script:
    - git fetch origin gh-pages
    - git checkout gh-pages
    - gem install bundler
    - bundle install

test-pages:
  stage: test
  extends: .pages-job
  script:
    - bundle exec jekyll build -d test
  artifacts:
    paths:
      - test
      
deploy-pages:
  stage: deploy
  extends: .pages-job
  script:
    - bundle exec jekyll build -d public
  artifacts:
    paths:
      - public
  environment: production
